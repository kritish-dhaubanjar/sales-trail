name: Electron App Build (Windows)

on:
  push:
    branches:
      - electron

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Set up PHP 8.3
        run: |
          $URI = "https://github.com/NativePHP/php-bin/raw/refs/heads/main/bin/win/x64/php-8.3.zip"
          $OutFile = "electron/php-bin/php-8.3.zip"
          $PHP = "electron/php-bin"

          Invoke-WebRequest -Uri $URI -OutFile $OutFile
          Expand-Archive -Path $OutFile -DestinationPath $PHP -Force
          Remove-Item -Path $OutFile -Force

          $php = "electron/php-bin/php.exe"
          echo "::add-path::$php"

      - name: Set up Composer
        run: |
          php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
          php composer-setup.php
          php -r "unlink('composer-setup.php');"

          Set-Content composer.bat '@php "%~dp0composer.phar" %*'
          echo "::add-path::electron/composer.bat"

      - name: Install Node.js Dependencies (app)
        run: |
          cd app
          npm install

      - name: Install PHP Dependencies (api)
        run: |
          cd api
          composer install --no-dev

      - name: Build app
        run: |
          cd app
          npm run build
